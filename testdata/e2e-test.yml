name: Deploy Testing
description: Verify that the deployment is correct

vars:
  github_token: "{{ GITHUB_TOKEN ?? '' }}"
  aws_access_key_id: "{{ AWS_ACCESS_KEY_ID ?? '' }}"
  aws_secret_access_key: "{{ AWS_SECRET_ACCESS_KEY ?? '' }}"
  google_application_credentials: "{{ GOOGLE_APPLICATION_CREDENTIALS ?? '' }}"

jobs:
- name: Check credentials
  id: check
  steps:
  - name: GITHUB_TOKEN is not empty
    uses: hello
    test: vars.github_token != ''
  - name: AWS_ACCESS_KEY_ID is not empty
    uses: hello
    test: vars.aws_access_key_id != ''
  - name: AWS_SECRET_ACCESS_KEY is not empty
    uses: hello
    test: vars.aws_secret_access_key != ''
  - name: GOOGLE_APPLICATION_CREDENTIALS is not empty
    uses: hello
    test: vars.google_application_credentials != ''

- name: Generate version
  id: generate_version
  needs: [check]
  steps:
  - name: Generate version string
    id: genver
    uses: hello
    vars:
      version: v3.0.0-{{ unixtime() }}
    outputs:
      version: vars.version
    echo: "Generated version: {{ vars.version }}"

- name: Build dewy
  id: build
  needs: [generate_version]
  steps:
  - name: Go build for {{ vars.command }}-{{ vars.registry }}
    uses: shell
    with:
      cmd: go build -o ./testdata/{{ vars.command }}/{{ vars.registry }}/dewy ./cmd/dewy
    test: status == 0
    iteration:
    - { command: 'server', registry: 'ghr' }
    - { command: 'server', registry: 's3' }
    - { command: 'server', registry: 'gs' }
    - { command: 'assets', registry: 'ghr' }
    - { command: 'assets', registry: 's3' }
    - { command: 'assets', registry: 'gs' }
    - { command: 'container', registry: 'img' }
    - { command: 'container-multiport', registry: 'img' }

# Phase 1: Start all dewy instances and wait for initial deployment (parallel)

- name: Start server by Github-Releases registry
  id: start_srv_ghr
  needs: [build]
  steps:
  - name: Start dewy
    id: srv_ghr
    uses: shell
    with:
      workdir: ./testdata/server/ghr
      background: true
      env:
        GITHUB_TOKEN: "{{ vars.github_token }}"
        AWS_ACCESS_KEY_ID: "{{ vars.aws_access_key_id }}"
        AWS_SECRET_ACCESS_KEY: "{{ vars.aws_secret_access_key }}"
        GOOGLE_APPLICATION_CREDENTIALS: "{{ vars.google_application_credentials }}"
      cmd: |
        ./dewy server -p 8000 -l debug \
        --registry "ghr://linyows/dewy-testapp?pre-release=true" \
        -- $PWD/current/dewy-testapp
    test: status == -1
    outputs:
      pid: res.pid
      log: res.log
    echo: |
      PID: {{ res.pid }}
      Log: {{ res.log }}
  - name: Wait for initial deployment
    uses: shell
    retry:
      max_attempts: 60
      interval: 5s
    with:
      cmd: |
        if [ -f "{{ outputs.srv_ghr.log }}" ]; then
          grep -q 'Create symlink' "{{ outputs.srv_ghr.log }}" && exit 0
        fi
        exit 1
    test: status == 0

- name: Start server by AWS S3 registry
  id: start_srv_s3
  needs: [build]
  steps:
  - name: Start dewy
    id: srv_s3
    uses: shell
    with:
      workdir: ./testdata/server/s3
      background: true
      env:
        GITHUB_TOKEN: "{{ vars.github_token }}"
        AWS_ACCESS_KEY_ID: "{{ vars.aws_access_key_id }}"
        AWS_SECRET_ACCESS_KEY: "{{ vars.aws_secret_access_key }}"
        GOOGLE_APPLICATION_CREDENTIALS: "{{ vars.google_application_credentials }}"
      cmd: |
        ./dewy server -p 8001 -l debug \
        --registry "s3://ap-northeast-3/dewy-testapp?pre-release=true" \
        -- $PWD/current/dewy-testapp
    test: status == -1
    outputs:
      pid: res.pid
      log: res.log
    echo: |
      PID: {{ res.pid }}
      Log: {{ res.log }}
  - name: Wait for initial deployment
    uses: shell
    retry:
      max_attempts: 60
      interval: 5s
    with:
      cmd: |
        if [ -f "{{ outputs.srv_s3.log }}" ]; then
          grep -q 'Create symlink' "{{ outputs.srv_s3.log }}" && exit 0
        fi
        exit 1
    test: status == 0

- name: Start server by GCloud Storage registry
  id: start_srv_gs
  needs: [build]
  steps:
  - name: Start dewy
    id: srv_gs
    uses: shell
    with:
      workdir: ./testdata/server/gs
      background: true
      env:
        GITHUB_TOKEN: "{{ vars.github_token }}"
        AWS_ACCESS_KEY_ID: "{{ vars.aws_access_key_id }}"
        AWS_SECRET_ACCESS_KEY: "{{ vars.aws_secret_access_key }}"
        GOOGLE_APPLICATION_CREDENTIALS: "{{ vars.google_application_credentials }}"
      cmd: |
        ./dewy server -p 8002 -l debug \
        --registry "gs://dewy-testapp?pre-release=true" \
        -- $PWD/current/dewy-testapp
    test: status == -1
    outputs:
      pid: res.pid
      log: res.log
    echo: |
      PID: {{ res.pid }}
      Log: {{ res.log }}
  - name: Wait for initial deployment
    uses: shell
    retry:
      max_attempts: 60
      interval: 5s
    with:
      cmd: |
        if [ -f "{{ outputs.srv_gs.log }}" ]; then
          grep -q 'Create symlink' "{{ outputs.srv_gs.log }}" && exit 0
        fi
        exit 1
    test: status == 0

- name: Start assets by Github-Releases registry
  id: start_ast_ghr
  needs: [build]
  steps:
  - name: Start dewy
    id: ast_ghr
    uses: shell
    with:
      workdir: ./testdata/assets/ghr
      background: true
      env:
        GITHUB_TOKEN: "{{ vars.github_token }}"
        AWS_ACCESS_KEY_ID: "{{ vars.aws_access_key_id }}"
        AWS_SECRET_ACCESS_KEY: "{{ vars.aws_secret_access_key }}"
        GOOGLE_APPLICATION_CREDENTIALS: "{{ vars.google_application_credentials }}"
      cmd: |
        rm -rf .dewy;
        ./dewy assets -l debug --registry "ghr://linyows/dewy-testapp?pre-release=true"
    test: status == -1
    outputs:
      pid: res.pid
      log: res.log
    echo: |
      PID: {{ res.pid }}
      Log: {{ res.log }}
  - name: Wait for initial deployment
    uses: shell
    retry:
      max_attempts: 60
      interval: 5s
    with:
      cmd: |
        if [ -f "{{ outputs.ast_ghr.log }}" ]; then
          grep -q 'Create symlink' "{{ outputs.ast_ghr.log }}" && exit 0
        fi
        exit 1
    test: status == 0

- name: Start assets by AWS S3 registry
  id: start_ast_s3
  needs: [build]
  steps:
  - name: Start dewy
    id: ast_s3
    uses: shell
    with:
      workdir: ./testdata/assets/s3
      background: true
      env:
        GITHUB_TOKEN: "{{ vars.github_token }}"
        AWS_ACCESS_KEY_ID: "{{ vars.aws_access_key_id }}"
        AWS_SECRET_ACCESS_KEY: "{{ vars.aws_secret_access_key }}"
        GOOGLE_APPLICATION_CREDENTIALS: "{{ vars.google_application_credentials }}"
      cmd: |
        rm -rf .dewy;
        ./dewy assets -l debug --registry "s3://ap-northeast-3/dewy-testapp?pre-release=true"
    test: status == -1
    outputs:
      pid: res.pid
      log: res.log
    echo: |
      PID: {{ res.pid }}
      Log: {{ res.log }}
  - name: Wait for initial deployment
    uses: shell
    retry:
      max_attempts: 60
      interval: 5s
    with:
      cmd: |
        if [ -f "{{ outputs.ast_s3.log }}" ]; then
          grep -q 'Create symlink' "{{ outputs.ast_s3.log }}" && exit 0
        fi
        exit 1
    test: status == 0

- name: Start assets by GCloud Storage registry
  id: start_ast_gs
  needs: [build]
  steps:
  - name: Start dewy
    id: ast_gs
    uses: shell
    with:
      workdir: ./testdata/assets/gs
      background: true
      env:
        GITHUB_TOKEN: "{{ vars.github_token }}"
        AWS_ACCESS_KEY_ID: "{{ vars.aws_access_key_id }}"
        AWS_SECRET_ACCESS_KEY: "{{ vars.aws_secret_access_key }}"
        GOOGLE_APPLICATION_CREDENTIALS: "{{ vars.google_application_credentials }}"
      cmd: |
        rm -rf .dewy;
        ./dewy assets -l debug --registry "gs://dewy-testapp?pre-release=true"
    test: status == -1
    outputs:
      pid: res.pid
      log: res.log
    echo: |
      PID: {{ res.pid }}
      Log: {{ res.log }}
  - name: Wait for initial deployment
    uses: shell
    retry:
      max_attempts: 60
      interval: 5s
    with:
      cmd: |
        if [ -f "{{ outputs.ast_gs.log }}" ]; then
          grep -q 'Create symlink' "{{ outputs.ast_gs.log }}" && exit 0
        fi
        exit 1
    test: status == 0

- name: Start container by OCI registry
  id: start_ctr_oci
  needs: [build]
  steps:
  - name: Start dewy
    id: ctr_oci
    uses: shell
    with:
      workdir: ./testdata/container/img
      background: true
      env:
        GITHUB_TOKEN: "{{ vars.github_token }}"
      cmd: |
        ./dewy container -p 7000 -l debug \
        --registry "img://ghcr.io/linyows/dewy-testapp?pre-release=true" \
        --health-path /health \
        --replicas 3
    test: status == -1
    outputs:
      pid: res.pid
      log: res.log
    echo: |
      PID: {{ res.pid }}
      Log: {{ res.log }}
  - name: Wait for initial deployment
    uses: shell
    retry:
      max_attempts: 180
      interval: 5s
    with:
      cmd: |
        if [ -f "{{ outputs.ctr_oci.log }}" ]; then
          grep -q 'Starting new container' "{{ outputs.ctr_oci.log }}" && exit 0
        fi
        exit 1
    test: status == 0

- name: Start container with multiple ports by OCI registry
  id: start_ctr_mp_oci
  needs: [build]
  steps:
  - name: Start dewy
    id: ctr_mp_oci
    uses: shell
    with:
      workdir: ./testdata/container-multiport/img
      background: true
      env:
        GITHUB_TOKEN: "{{ vars.github_token }}"
      cmd: |
        ./dewy container \
        --name dewy-testapp-multiport \
        -p 7100:3333 \
        -p 7101:3333 \
        -l debug \
        --registry "img://ghcr.io/linyows/dewy-testapp?pre-release=true" \
        --health-path /health \
        --replicas 2
    test: status == -1
    outputs:
      pid: res.pid
      log: res.log
    echo: |
      PID: {{ res.pid }}
      Log: {{ res.log }}
  - name: Wait for initial deployment
    uses: shell
    retry:
      max_attempts: 180
      interval: 5s
    with:
      cmd: |
        if [ -f "{{ outputs.ctr_mp_oci.log }}" ]; then
          grep -q 'Starting new container' "{{ outputs.ctr_mp_oci.log }}" && exit 0
        fi
        exit 1
    test: status == 0

# Phase 2: Create new version (after ALL dewy instances have deployed initial version)

- name: Create new version
  id: create_release
  needs: [start_srv_ghr, start_srv_s3, start_srv_gs, start_ast_ghr, start_ast_s3, start_ast_gs, start_ctr_oci, start_ctr_mp_oci]
  steps:
  - name: Create release
    uses: shell
    with:
      env:
        GH_TOKEN: "{{ vars.github_token }}"
      cmd: |
        gh release create {{ outputs.genver.version }} \
          --repo linyows/dewy-testapp \
          --title {{ outputs.genver.version }} \
          --notes "End-to-end Testing by Probe"
    test: status == 0
    echo: |
      {{res.stdout}}
  - name: Verify release exists
    uses: shell
    retry:
      max_attempts: 10
      interval: 2s
    with:
      env:
        GH_TOKEN: "{{ vars.github_token }}"
      cmd: |
        gh release view {{ outputs.genver.version }} \
          --repo linyows/dewy-testapp
    test: status == 0

# Phase 3: Wait for new version and verify (parallel)

- name: Verify server by Github-Releases registry
  needs: [create_release]
  steps:
  - name: Server verify
    uses: embedded
    with:
      path: ./testdata/jobs/server-verify.yml
      vars:
        pid: "{{ outputs.srv_ghr.pid }}"
        log: "{{ outputs.srv_ghr.log }}"
        new_version: "{{ outputs.genver.version }}"
    test: res.code == 0
    timeout: 15m

- name: Verify server by AWS S3 registry
  needs: [create_release]
  steps:
  - name: Server verify
    uses: embedded
    with:
      path: ./testdata/jobs/server-verify.yml
      vars:
        pid: "{{ outputs.srv_s3.pid }}"
        log: "{{ outputs.srv_s3.log }}"
        new_version: "{{ outputs.genver.version }}"
    test: res.code == 0
    timeout: 15m

- name: Verify server by GCloud Storage registry
  needs: [create_release]
  steps:
  - name: Server verify
    uses: embedded
    with:
      path: ./testdata/jobs/server-verify.yml
      vars:
        pid: "{{ outputs.srv_gs.pid }}"
        log: "{{ outputs.srv_gs.log }}"
        new_version: "{{ outputs.genver.version }}"
    test: res.code == 0
    timeout: 15m

- name: Verify assets by Github-Releases registry
  needs: [create_release]
  steps:
  - name: Assets verify
    uses: embedded
    with:
      path: ./testdata/jobs/assets-verify.yml
      vars:
        pid: "{{ outputs.ast_ghr.pid }}"
        log: "{{ outputs.ast_ghr.log }}"
        new_version: "{{ outputs.genver.version }}"
    test: res.code == 0
    timeout: 15m

- name: Verify assets by AWS S3 registry
  needs: [create_release]
  steps:
  - name: Assets verify
    uses: embedded
    with:
      path: ./testdata/jobs/assets-verify.yml
      vars:
        pid: "{{ outputs.ast_s3.pid }}"
        log: "{{ outputs.ast_s3.log }}"
        new_version: "{{ outputs.genver.version }}"
    test: res.code == 0
    timeout: 15m

- name: Verify assets by GCloud Storage registry
  needs: [create_release]
  steps:
  - name: Assets verify
    uses: embedded
    with:
      path: ./testdata/jobs/assets-verify.yml
      vars:
        pid: "{{ outputs.ast_gs.pid }}"
        log: "{{ outputs.ast_gs.log }}"
        new_version: "{{ outputs.genver.version }}"
    test: res.code == 0
    timeout: 15m

- name: Verify container by OCI registry
  needs: [create_release]
  steps:
  - name: Container verify
    uses: embedded
    with:
      path: ./testdata/jobs/container-verify.yml
      vars:
        pid: "{{ outputs.ctr_oci.pid }}"
        log: "{{ outputs.ctr_oci.log }}"
        new_version: "{{ outputs.genver.version }}"
    test: res.code == 0
    timeout: 30m

- name: Verify container with multiple ports by OCI registry
  needs: [create_release]
  steps:
  - name: Container multi-port verify
    uses: embedded
    with:
      path: ./testdata/jobs/container-multiport-verify.yml
      vars:
        pid: "{{ outputs.ctr_mp_oci.pid }}"
        log: "{{ outputs.ctr_mp_oci.log }}"
        port1: 7100
        port2: 7101
        replicas: 2
        new_version: "{{ outputs.genver.version }}"
    test: res.code == 0
    timeout: 30m
