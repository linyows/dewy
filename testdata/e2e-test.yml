name: Deploy Testing
description: Verify that the deployment is correct

vars:
  github_token: "{{ GITHUB_TOKEN ?? '' }}"
  aws_access_key_id: "{{ AWS_ACCESS_KEY_ID ?? '' }}"
  aws_secret_access_key: "{{ AWS_SECRET_ACCESS_KEY ?? '' }}"
  google_application_credentials: "{{ GOOGLE_APPLICATION_CREDENTIALS ?? '' }}"

jobs:
- name: Check credentials
  id: check
  steps:
  - name: GITHUB_TOKEN is not empty
    uses: hello
    test: vars.github_token != ''
  - name: AWS_ACCESS_KEY_ID is not empty
    uses: hello
    test: vars.aws_access_key_id != ''
  - name: AWS_SECRET_ACCESS_KEY is not empty
    uses: hello
    test: vars.aws_secret_access_key != ''
  - name: GOOGLE_APPLICATION_CREDENTIALS is not empty
    uses: hello
    test: vars.google_application_credentials != ''

- name: Generate version
  id: generate_version
  needs: [check]
  steps:
  - name: Generate version string
    id: genver
    uses: hello
    vars:
      version: v3.0.0-{{ unixtime() }}
    outputs:
      version: vars.version
    echo: "Generated version: {{ vars.version }}"

- name: Build dewy
  id: build
  needs: [generate_version]
  steps:
  - name: Go build for {{ vars.command }}-{{ vars.registry }}
    uses: shell
    with:
      cmd: go build -o ./testdata/{{ vars.command }}/{{ vars.registry }}/dewy ./cmd/dewy
    test: status == 0
    iteration:
    - { command: 'server', registry: 'ghr' }
    - { command: 'server', registry: 's3' }
    - { command: 'server', registry: 'gs' }
    - { command: 'assets', registry: 'ghr' }
    - { command: 'assets', registry: 's3' }
    - { command: 'assets', registry: 'gs' }
    - { command: 'container', registry: 'img' }
    - { command: 'container-multiport', registry: 'img' }

- name: Run server by Github-Releases registry
  needs: [build]
  steps:
  - name: Server test
    uses: embedded
    with:
      path: ./testdata/jobs/server.yml
      vars:
        github_token: "{{ vars.github_token }}"
        aws_access_key_id: "{{ vars.aws_access_key_id }}"
        aws_secret_access_key: "{{ vars.aws_secret_access_key }}"
        google_application_credentials: "{{ vars.google_application_credentials }}"
        registry: ghr
        registry_url: "ghr://linyows/dewy-testapp?pre-release=true"
        port: 8000
        log_level: debug
        new_version: "{{ outputs.genver.version }}"
    test: res.code == 0
    timeout: 15m

- name: Run server by AWS S3 registry
  needs: [build]
  steps:
  - name: Server test
    uses: embedded
    with:
      path: ./testdata/jobs/server.yml
      vars:
        github_token: "{{ vars.github_token }}"
        aws_access_key_id: "{{ vars.aws_access_key_id }}"
        aws_secret_access_key: "{{ vars.aws_secret_access_key }}"
        google_application_credentials: "{{ vars.google_application_credentials }}"
        registry: s3
        registry_url: "s3://ap-northeast-3/dewy-testapp?pre-release=true"
        port: 8001
        log_level: debug
        new_version: "{{ outputs.genver.version }}"
    test: res.code == 0
    timeout: 15m

- name: Run server by GCloud Storage registry
  needs: [build]
  steps:
  - name: Server test
    uses: embedded
    with:
      path: ./testdata/jobs/server.yml
      vars:
        github_token: "{{ vars.github_token }}"
        aws_access_key_id: "{{ vars.aws_access_key_id }}"
        aws_secret_access_key: "{{ vars.aws_secret_access_key }}"
        google_application_credentials: "{{ vars.google_application_credentials }}"
        registry: gs
        registry_url: "gs://dewy-testapp?pre-release=true"
        port: 8002
        log_level: debug
        new_version: "{{ outputs.genver.version }}"
    test: res.code == 0
    timeout: 15m

- name: Run assets by Github-Releases registry
  needs: [build]
  steps:
  - name: Assets test
    uses: embedded
    with:
      path: ./testdata/jobs/assets.yml
      vars:
        github_token: "{{ vars.github_token }}"
        aws_access_key_id: "{{ vars.aws_access_key_id }}"
        aws_secret_access_key: "{{ vars.aws_secret_access_key }}"
        google_application_credentials: "{{ vars.google_application_credentials }}"
        registry: ghr
        registry_url: "ghr://linyows/dewy-testapp?pre-release=true"
        port: 9000
        log_level: debug
        new_version: "{{ outputs.genver.version }}"
    test: res.code == 0
    timeout: 15m

- name: Run assets by AWS S3 registry
  needs: [build]
  steps:
  - name: Assets test
    uses: embedded
    with:
      path: ./testdata/jobs/assets.yml
      vars:
        github_token: "{{ vars.github_token }}"
        aws_access_key_id: "{{ vars.aws_access_key_id }}"
        aws_secret_access_key: "{{ vars.aws_secret_access_key }}"
        google_application_credentials: "{{ vars.google_application_credentials }}"
        registry: s3
        registry_url: "s3://ap-northeast-3/dewy-testapp?pre-release=true"
        port: 9001
        log_level: debug
        new_version: "{{ outputs.genver.version }}"
    test: res.code == 0
    timeout: 15m

- name: Run assets by GCloud Storage registry
  needs: [build]
  steps:
  - name: Assets test
    uses: embedded
    with:
      path: ./testdata/jobs/assets.yml
      vars:
        github_token: "{{ vars.github_token }}"
        aws_access_key_id: "{{ vars.aws_access_key_id }}"
        aws_secret_access_key: "{{ vars.aws_secret_access_key }}"
        google_application_credentials: "{{ vars.google_application_credentials }}"
        registry: gs
        registry_url: "gs://dewy-testapp?pre-release=true"
        port: 9002
        log_level: debug
        new_version: "{{ outputs.genver.version }}"
    test: res.code == 0
    timeout: 15m

- name: Run container by OCI registry
  needs: [build]
  steps:
  - name: Container test
    uses: embedded
    with:
      path: ./testdata/jobs/container.yml
      vars:
        github_token: "{{ vars.github_token }}"
        registry: img
        registry_url: "img://ghcr.io/linyows/dewy-testapp?pre-release=true"
        port: 7000
        replicas: 3
        log_level: debug
        new_version: "{{ outputs.genver.version }}"
    test: res.code == 0
    timeout: 30m

- name: Run container with multiple ports by OCI registry
  needs: [build]
  steps:
  - name: Container multi-port test
    uses: embedded
    with:
      path: ./testdata/jobs/container-multiport.yml
      vars:
        github_token: "{{ vars.github_token }}"
        registry: img
        registry_url: "img://ghcr.io/linyows/dewy-testapp?pre-release=true"
        port1: 7100
        port2: 7101
        container_port: 3333
        replicas: 2
        log_level: debug
        new_version: "{{ outputs.genver.version }}"
    test: res.code == 0
    timeout: 30m
