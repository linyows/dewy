name: Container Multi-Port Verify

steps:
- name: Wait for new version to start
  uses: shell
  retry:
    max_attempts: 180
    interval: 5s
  with:
    cmd: |
      if [ -f "{{ vars.log }}" ]; then
        grep "Starting new container" "{{ vars.log }}" | \
          grep -q "{{ vars.new_version }}" && exit 0
      fi
      exit 1
  test: status == 0

- name: Wait for stabilization
  wait: 60s
  uses: shell
  with:
    cmd: "echo 'Waiting for system stabilization after new version detection'"
  test: status == 0

- name: Verify TCP proxy started on port1
  id: proxy1
  uses: shell
  with:
    cmd: |
      grep 'TCP proxy started' {{ vars.log }} | \
        grep -c 'proxy_port={{ vars.port1 }}' | tr -d '\n'
  test: res.stdout == "1"
  outputs:
    ok: res.stdout == "1"

- name: Verify TCP proxy started on port2
  id: proxy2
  uses: shell
  with:
    cmd: |
      grep 'TCP proxy started' {{ vars.log }} | \
        grep -c 'proxy_port={{ vars.port2 }}' | tr -d '\n'
  test: res.stdout == "1"
  outputs:
    ok: res.stdout == "1"

- name: Verify all TCP proxies started
  id: allproxies
  uses: shell
  with:
    cmd: |
      grep 'All TCP proxies started successfully' {{ vars.log }} | \
        grep -c 'count=2' | tr -d '\n'
  test: res.stdout == "1"
  outputs:
    ok: res.stdout == "1"

- name: Verify backends added to port1
  id: backend1
  uses: shell
  with:
    cmd: |
      grep 'Backend added to TCP proxy' {{ vars.log }} | \
        grep -c 'proxy_port={{ vars.port1 }}' | tr -d '\n'
  test: int(res.stdout) >= int(vars.replicas)
  outputs:
    ok: int(res.stdout) >= int(vars.replicas)

- name: Verify backends added to port2
  id: backend2
  uses: shell
  with:
    cmd: |
      grep 'Backend added to TCP proxy' {{ vars.log }} | \
        grep -c 'proxy_port={{ vars.port2 }}' | tr -d '\n'
  test: int(res.stdout) >= int(vars.replicas)
  outputs:
    ok: int(res.stdout) >= int(vars.replicas)

- name: Test connection to port1
  id: conn1
  uses: shell
  retry:
    max_attempts: 5
    interval: 2s
  with:
    cmd: "curl -s -o /dev/null -w '%{http_code}' http://localhost:{{ vars.port1 }}/health"
  test: res.stdout == "200"
  outputs:
    ok: res.stdout == "200"

- name: Test connection to port2
  id: conn2
  uses: shell
  retry:
    max_attempts: 5
    interval: 2s
  with:
    cmd: "curl -s -o /dev/null -w '%{http_code}' http://localhost:{{ vars.port2 }}/health"
  test: res.stdout == "200"
  outputs:
    ok: res.stdout == "200"

- name: Verify containers are not running as root
  id: notroot
  uses: shell
  with:
    cmd: |
      # Get all container IDs managed by dewy
      containers=$(docker ps --filter "label=dewy.managed=true" -q)
      if [ -z "$containers" ]; then
        echo "No dewy-managed containers found"
        exit 1
      fi
      # Check each container's process user
      for cid in $containers; do
        uid=$(docker top "$cid" -o uid | tail -n +2 | head -1 | tr -d ' ')
        if [ "$uid" = "0" ]; then
          echo "Container $cid is running as root (UID=0)"
          exit 1
        fi
        echo "Container $cid is running as UID=$uid (not root)"
      done
      echo "All containers are running as non-root user"
  test: status == 0
  outputs:
    ok: status == 0

- name: Stop dewy
  uses: shell
  with: # Use Process Group ID
    cmd: "kill -TERM -{{ vars.pid }}"
  test: status == 0

- name: Verify no error
  id: noerr
  uses: shell
  with:
    cmd: "grep 'level=ERROR' {{ vars.log }}"
  test: status == 1
  outputs:
    ok: status == 1

- name: Verify new containers created
  id: nver
  uses: shell
  with:
    cmd: |
      grep 'Starting new container' {{ vars.log }} | \
        grep -c {{ vars.new_version }} | tr -d '\n'
  test: int(res.stdout) == int(vars.replicas)
  outputs:
    ok: int(res.stdout) == int(vars.replicas)

- name: Show log
  skipif: outputs.noerr.ok && outputs.proxy1.ok && outputs.proxy2.ok && outputs.allproxies.ok && outputs.backend1.ok && outputs.backend2.ok && outputs.conn1.ok && outputs.conn2.ok && outputs.notroot.ok && outputs.nver.ok
  uses: shell
  with:
    cmd: "cat {{ vars.log }}"
  echo: "{{ res.stdout }}"
