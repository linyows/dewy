name: Assets Test

steps:
- name: Start dewy
  id: server
  uses: shell
  with:
    workdir: ./testdata/assets/{{ vars.registry }}
    background: true
    env:
      GITHUB_TOKEN: "{{ vars.github_token }}"
      AWS_ACCESS_KEY_ID: "{{ vars.aws_access_key_id }}"
      AWS_SECRET_ACCESS_KEY: "{{ vars.aws_secret_access_key }}"
      GOOGLE_APPLICATION_CREDENTIALS: "{{ vars.google_application_credentials }}"
    cmd: |
      rm -rf .dewy;
      ./dewy assets -l {{ vars.log_level }} --registry "{{ vars.registry_url }}"
  test: status == -1
  outputs:
    pid: res.pid
    log: res.log
  echo: |
    PID: {{ res.pid }}
    Log: {{ res.log }}

- name: Wait for initial deployment
  uses: shell
  retry:
    max_attempts: 60
    interval: 5s
  with:
    cmd: |
      if [ -f "{{ outputs.server.log }}" ]; then
        grep -q 'Create symlink' "{{ outputs.server.log }}" && exit 0
      fi
      exit 1
  test: status == 0

- name: Create new version
  uses: shell
  with:
    env:
      GH_TOKEN: "{{ vars.github_token }}"
    cmd: |
      gh release create {{ vars.new_version }} \
        --repo linyows/dewy-testapp \
        --title {{ vars.new_version }} \
        --notes "End-to-end Testing by Probe" 2>&1 || true
  test: status == 0

- name: Verify release exists
  uses: shell
  retry:
    max_attempts: 10
    interval: 2s
  with:
    env:
      GH_TOKEN: "{{ vars.github_token }}"
    cmd: |
      gh release view {{ vars.new_version }} \
        --repo linyows/dewy-testapp
  test: status == 0

- name: Wait for new version download
  uses: shell
  retry:
    max_attempts: 60
    interval: 5s
  with:
    cmd: |
      if [ -f "{{ outputs.server.log }}" ]; then
        grep "Download notification" "{{ outputs.server.log }}" | \
          grep -q "{{ replace(vars.new_version, 'v', '') }}" && exit 0
      fi
      exit 1
  test: status == 0

- name: Wait for stabilization
  wait: 30s
  uses: shell
  with:
    cmd: "echo 'Waiting for system stabilization after new version detection'"
  test: status == 0

- name: Stop dewy
  uses: shell
  with: # Use Process Group ID
    cmd: "kill -TERM -{{ outputs.server.pid }}"
  test: status == 0

- name: Verify no error
  id: noerr
  uses: shell
  with:
    cmd: "grep -i error {{ outputs.server.log }}"
  test: status == 1
  outputs:
    ok: status == 1

- name: Verify two symlinks creates
  id: twosyml
  uses: shell
  with:
    cmd: |
      grep -c 'Create symlink' {{ outputs.server.log }} | tr -d '\n'
  test: res.stdout == "2"
  outputs:
    ok: res.stdout == "2"

- name: Verify starting two version
  id: twover
  uses: shell
  with:
    cmd: |
      grep -c 'Download notification' {{ outputs.server.log }} | tr -d '\n'
  test: res.stdout == "2"
  outputs:
    ok: res.stdout == "2"

- name: Verify starting new version
  id: newver
  uses: shell
  with:
    cmd: |
      grep 'Download notification' {{ outputs.server.log }} | \
        grep {{ replace(vars.new_version, 'v', '') }}
  test: status == 0
  outputs:
    ok: status == 0

- name: Show log
  skipif: outputs.noerr.ok && outputs.twosyml.ok && outputs.twover.ok && outputs.newver.ok
  uses: shell
  with:
    cmd: "cat {{ outputs.server.log }}"
  echo: "{{ res.stdout }}"
